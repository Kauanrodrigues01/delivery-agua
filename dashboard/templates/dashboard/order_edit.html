{% extends 'base.html' %}

{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'global/form-default-style.css' %}">
<link rel="stylesheet" href="{% static 'global/buttons-default-style.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/order_edit.css' %}">

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="container">
        <div class="order-form">
            <h2>Editar Pedido #{{ order.id }}</h2>

            <form method="post" action="{% url 'dashboard:order_edit' order.pk %}">
                {% csrf_token %}

                <!-- Informações do Cliente -->
                <div class="form-section">
                    <h3>Informações do Cliente</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer_name">Nome do Cliente</label>
                            <input type="text" id="customer_name" name="customer_name" class="form-control"
                                value="{{ order.customer_name }}" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Telefone</label>
                            <input type="tel" id="phone" name="phone" class="form-control" value="{{ order.phone }}"
                                required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Endereço de Entrega</label>
                        <input type="text" id="address" name="address" class="form-control" required
                            value="{{ order.address }}">
                    </div>
                    <div class="form-group">
                        <label for="status">Status do Pedido</label>
                        <select id="status" name="status" class="form-control">
                            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pendente
                            </option>
                            <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Concluído
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Produtos -->
                <div class="form-section">
                    <h3>Produtos do Pedido</h3>
                    
                    {% if not order.can_edit_items %}
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; color: #856404;">
                        <strong>⚠️ Atenção:</strong> Este pedido já foi pago. Não é possível adicionar ou remover produtos, apenas editar informações básicas como nome, telefone e endereço.
                    </div>
                    
                    <!-- Lista de Produtos (apenas visualização) -->
                    <div class="added-products-section">
                        <h4>Produtos no Pedido (não editável)</h4>
                        <div class="products-list">
                            {% for item in order.items.all %}
                            <div class="product-item" style="opacity: 0.8;">
                                <div class="product-info">
                                    <div class="product-name">{{ item.product.name }}</div>
                                    <div class="product-price">R$ {{ item.product.price|floatformat:2 }} cada</div>
                                </div>
                                <div style="margin-left: 1rem;">
                                    <strong>{{ item.quantity }} unidade{{ item.quantity|pluralize }}</strong>
                                </div>
                                <div style="margin-left: 1rem;">
                                    <strong>R$ {{ item.product.price|floatformat:2 }}</strong>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="product-total">Total do Pedido: R$ {{ order.total_price|floatformat:2 }}</div>
                        </div>
                    </div>
                    {% else %}
                    <!-- Adicionar Produto -->
                    <div class="add-product-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="product_select">Adicionar Produto</label>
                                <select id="product_select" class="form-control" data-placeholder="Clique para selecionar produtos...">
                                    <option value=""></option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" data-name="{{ product.name }}"
                                        data-price="{{ product.price }}">
                                        {{ product.name }} - R$ {{ product.price|floatformat:2 }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="product_quantity">Quantidade</label>
                                <input type="number" id="product_quantity" class="form-control" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label style="visibility: hidden;">Ação</label>
                                <button type="button" id="add_product_btn" class="btn add-btn">
                                    Adicionar Produto
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Produtos Adicionados -->
                    <div class="added-products-section">
                        <h4>Produtos no Pedido</h4>
                        <div id="added_products_list" class="products-list">
                            <!-- Os produtos serão carregados via JavaScript -->
                        </div>
                    </div>

                    <!-- Hidden inputs para envio do formulário -->
                    <div id="hidden_inputs_container"></div>
                    {% endif %}
                </div>

                <div class="action-buttons">
                    <a href="{% url 'dashboard:order_detail' order.pk %}" class="btn cancel-btn">
                        Cancelar
                    </a>
                    <button type="submit" class="btn add-btn">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    let addedProducts = [];
    let productCounter = 0;

    // Initialize Select2
    $(document).ready(function () {
        // Só inicializar Select2 se pode editar itens
        {% if order.can_edit_items %}
        // Destroy any existing Select2 instance
        if ($('#product_select').hasClass("select2-hidden-accessible")) {
            $('#product_select').select2('destroy');
        }

        $('#product_select').select2({
            placeholder: 'Clique para selecionar produtos...',
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            dropdownAutoWidth: false,
            dropdownParent: $('.add-product-section'),
            language: {
                noResults: function () {
                    return "Nenhum produto encontrado";
                },
                searching: function () {
                    return "Buscando...";
                },
                inputTooShort: function () {
                    return "Clique para ver todos os produtos";
                },
                loadingMore: function () {
                    return "Carregando mais resultados...";
                },
                errorLoading: function () {
                    return "Erro ao carregar resultados";
                }
            },
            templateResult: function (data) {
                if (data.loading) {
                    return $('<div class="select2-result-loading">Carregando...</div>');
                }

                if (!data.id) {
                    return data.text;
                }

                try {
                    // Custom template for results with price highlighting
                    var textParts = data.text.split(' - ');
                    var productName = textParts[0] || '';
                    var productPrice = textParts[1] || '';

                    var $result = $(
                        '<div class="select2-result-product">' +
                        '<div class="select2-result-product__name">' + productName + '</div>' +
                        '<div class="select2-result-product__price">' + productPrice + '</div>' +
                        '</div>'
                    );

                    return $result;
                } catch (e) {
                    return data.text;
                }
            },
            templateSelection: function (data) {
                if (data.id && data.text) {
                    try {
                        // Show only product name in selection
                        return data.text.split(' - ')[0];
                    } catch (e) {
                        return data.text;
                    }
                }
                return data.text;
            },
            escapeMarkup: function (markup) {
                return markup;
            }
        });

        // Handle selection change
        $('#product_select').on('select2:select', function (e) {
            // Auto-focus quantity input when product is selected
            setTimeout(function() {
                $('#product_quantity').focus();
            }, 100);
        });

        // Handle dropdown open/close for mobile
        $('#product_select').on('select2:open', function (e) {
            // Add class to body to handle mobile scroll
            $('body').addClass('select2-dropdown-open');
            
            // Ensure dropdown is positioned correctly
            setTimeout(function() {
                const dropdown = $('.select2-dropdown');
                dropdown.css({
                    'position': 'absolute',
                    'z-index': '999999',
                    'top': '100%',
                    'bottom': 'auto'
                });
            }, 10);
        });

        $('#product_select').on('select2:close', function (e) {
            // Remove class from body
            $('body').removeClass('select2-dropdown-open');
        });

        // Handle errors gracefully
        $('#product_select').on('select2:select select2:unselect', function (e) {
            try {
                // Clear any error states
                $(this).removeClass('error');
            } catch (error) {
                console.warn('Select2 event error:', error);
            }
        });

        // Load existing products after Select2 is initialized
        loadExistingProducts();
        {% endif %}
    });

    // Load existing products function
    function loadExistingProducts() {
        {% if order.can_edit_items %}
        // Carregar produtos existentes do pedido via dados do template
        {% for product_info in products_with_order_info %}
        {% if product_info.is_in_order %}
        addedProducts.push({
            id: '{{ product_info.product.id }}',
            name: '{{ product_info.product.name|escapejs }}',
            price: parseFloat('{{ product_info.product.price }}'),
            quantity: parseInt('{{ product_info.quantity }}'),
            total: parseFloat('{{ product_info.product.price }}') * parseInt('{{ product_info.quantity }}'),
            counter: productCounter++
        });
        {% endif %}
        {% endfor %}

        updateProductsList();
        updateHiddenInputs();
        {% endif %}
    }

    // Adicionar produto ao pedido
    {% if order.can_edit_items %}
    document.getElementById('add_product_btn').addEventListener('click', function () {
        const select = document.getElementById('product_select');
        const quantityInput = document.getElementById('product_quantity');

        if (!select.value) {
            alert('Selecione um produto primeiro.');
            return;
        }

        const productId = select.value;
        const quantity = parseInt(quantityInput.value);
        const selectedOption = select.options[select.selectedIndex];
        const productName = selectedOption.dataset.name;
        const productPrice = parseFloat(selectedOption.dataset.price);

        // Verificar se produto já foi adicionado
        const existingProduct = addedProducts.find(p => p.id === productId);
        if (existingProduct) {
            alert('Este produto já foi adicionado. Use o campo de quantidade para alterar.');
            return;
        }

        // Adicionar produto à lista
        const product = {
            id: productId,
            name: productName,
            price: productPrice,
            quantity: quantity,
            total: productPrice * quantity,
            counter: productCounter++
        };

        addedProducts.push(product);
        updateProductsList();
        updateHiddenInputs();

        // Limpar seleção
        $('#product_select').val(null).trigger('change');
        quantityInput.value = 1;
    });
    {% endif %}

    // Atualizar lista visual de produtos
    function updateProductsList() {
        const container = document.getElementById('added_products_list');

        if (addedProducts.length === 0) {
            container.innerHTML = '<p class="no-products-message">Nenhum produto adicionado ainda.</p>';
            return;
        }

        let html = '';
        let totalGeneral = 0;

        addedProducts.forEach(product => {
            totalGeneral += product.total;
            html += `
                <div class="product-item" data-product-id="${product.id}">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">R$ ${product.price.toFixed(2)} cada</div>
                    </div>
                    <input type="number" 
                           class="product-quantity form-control" 
                           min="1" 
                           value="${product.quantity}"
                           onchange="updateProductQuantity('${product.id}', this.value)">
                    <div style="margin-left: 1rem;">
                        <strong>R$ ${product.total.toFixed(2)}</strong>
                    </div>
                    <button type="button" 
                            class="remove-btn" 
                            onclick="removeProduct('${product.id}')">
                        Remover
                    </button>
                </div>
            `;
        });

        html += `<div class="product-total">Total do Pedido: R$ ${totalGeneral.toFixed(2)}</div>`;
        container.innerHTML = html;
    }

    // Atualizar quantidade de um produto
    function updateProductQuantity(productId, newQuantity) {
        const product = addedProducts.find(p => p.id === productId);
        if (product) {
            product.quantity = parseInt(newQuantity);
            product.total = product.price * product.quantity;
            updateProductsList();
            updateHiddenInputs();
        }
    }

    // Remover produto
    function removeProduct(productId) {
        addedProducts = addedProducts.filter(p => p.id !== productId);
        updateProductsList();
        updateHiddenInputs();
    }

    // Atualizar inputs hidden para envio do formulário
    function updateHiddenInputs() {
        const container = document.getElementById('hidden_inputs_container');
        let html = '';

        addedProducts.forEach(product => {
            html += `
                <input type="hidden" name="product_id" value="${product.id}">
                <input type="hidden" name="quantity" value="${product.quantity}">
            `;
        });

        container.innerHTML = html;
    }

    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function (e) {
        {% if order.can_edit_items %}
        if (addedProducts.length === 0) {
            e.preventDefault();
            alert('Adicione pelo menos um produto ao pedido.');
            return false;
        }
        {% endif %}
    });
</script>
{% endblock %}