{% extends 'base.html' %}

{% load static %}
{% load math_filters %}

{% block head %}
<link rel="stylesheet" href="{% static 'global/form-default-style.css' %}">
<link rel="stylesheet" href="{% static 'global/buttons-default-style.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/action-buttons-style.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/order_detail.css' %}">
<style>
    
</style>
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="container">
        <div class="order-detail">
            <div class="order-header">
                <h2>
                    Pedido #{{ order.id }}
                    {% if order.is_late %}
                    <span class="late-indicator">ATRASADO</span>
                    {% endif %}
                </h2>
                <div
                    class="order-status {% if order.status == 'pending' %}status-pending{% elif order.status == 'completed' %}status-completed{% else %}status-cancelled{% endif %}">
                    {% if order.status == 'pending' %}
                    Pendente
                    {% elif order.status == 'completed' %}
                    Conclu√≠do
                    {% else %}
                    Cancelado
                    {% endif %}
                </div>
            </div>

            <div class="order-info">
                <div class="info-group">
                    <h4>Cliente</h4>
                    <p>{{ order.customer_name }}</p>
                </div>
                <div class="info-group">
                    <h4>Telefone</h4>
                    <p>{{ order.phone }}</p>
                </div>
                <div class="info-group">
                    <h4>Data do Pedido</h4>
                    <p>{{ order.created_at|date:"d/m/Y H:i" }}</p>
                    {% if order.is_late %}
                    <small class="late-warning-text">Pedido em atraso (mais de 25 minutos)</small>
                    {% endif %}
                </div>
                <div class="info-group">
                    <h4>M√©todo de Pagamento</h4>
                    <p>{{ order.get_payment_method_display }}</p>
                </div>
                <div class="info-group">
                    <h4>Status do Pagamento</h4>
                    <p>
                        {% if order.payment_status == 'pending' %}
                        <span style="color: #ffc107; font-weight: bold;">Pendente</span>
                        {% elif order.payment_status == 'paid' %}
                        <span style="color: #28a745; font-weight: bold;">Pago</span>
                        {% else %}
                        <span style="color: #dc3545; font-weight: bold;">Cancelado/Devolvido</span>
                        {% endif %}
                    </p>
                    {% if order.payment_status == 'cancelled' %}
                    <small style="color: #6c757d; font-style: italic;">
                        Pagamento cancelado - dinheiro devolvido ou transa√ß√£o cancelada
                    </small>
                    {% endif %}
                </div>
                {% if order.payment_method == 'dinheiro' and order.cash_value %}
                <div class="info-group">
                    <h4>Valor Recebido</h4>
                    <p>R$ {{ order.cash_value|floatformat:2 }}</p>
                </div>
                <div class="info-group">
                    <h4>Troco</h4>
                    <p>R$ {{ order.change_amount|floatformat:2 }}</p>
                </div>
                {% endif %}
                <div class="info-group">
                    <h4>Endere√ßo de Entrega</h4>
                    <p>{{ order.address }}</p>
                </div>
            </div>

            <div class="order-items">
                <h3>Itens do Pedido</h3>

                <!-- Desktop/Tablet Table -->
                <div class="table-container">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th class="name-col">Produto</th>
                                <th class="quantity-col">Quantidade</th>
                                <th class="price-col">Pre√ßo Unit√°rio</th>
                                <th class="subtotal-col">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                            <tr>
                                <td class="name-col">{{ item.product.name }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>R$ {{ item.product.price|floatformat:2 }}</td>
                                <td>R$ {{ item.product.price|mul:item.quantity|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="mobile-items">
                    {% for item in order.items.all %}
                    <div class="item-card">
                        <h5>{{ item.product.name }}</h5>
                        <div class="item-details">
                            <div class="item-detail">
                                <strong>Quantidade</strong>
                                <span>{{ item.quantity }} unidade{{ item.quantity|pluralize }}</span>
                            </div>
                            <div class="item-detail">
                                <strong>Pre√ßo Unit√°rio</strong>
                                <span>R$ {{ item.product.price|floatformat:2 }}</span>
                            </div>
                            <div class="item-detail subtotal">
                                <strong>Subtotal</strong>
                                <span>R$ {{ item.product.price|mul:item.quantity|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="order-total">
                    <div class="total-amount">
                        Total: R$ {{ order.total_price|floatformat:2 }}
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <a href="{% url 'dashboard:order_list' %}" class="btn btn-secondary">
                    Voltar √† Lista
                </a>
                {% if order.is_finalized %}
                <div class="status-box status-box-success">
                    <strong>‚úÖ Pedido Finalizado</strong>
                    <small>Este pedido foi conclu√≠do e pago. N√£o √© poss√≠vel fazer mais altera√ß√µes.</small>
                </div>
                {% elif order.is_totally_cancelled %}
                <!-- Pedido totalmente cancelado: apenas visualiza√ß√£o -->
                <div class="status-box status-box-neutral">
                    <strong>üö´ Pedido Totalmente Cancelado</strong>
                    <small>Este pedido e seu pagamento foram cancelados. Nenhuma altera√ß√£o √© permitida.</small>
                </div>
                {% elif order.status == 'pending' and order.payment_status == 'cancelled' %}
                <!-- Pedido pendente com pagamento cancelado: s√≥ pode cancelar o pedido -->
                <div class="status-box status-box-danger">
                    <strong>‚ö†Ô∏è Pagamento Cancelado</strong>
                    <small>Este pedido teve o pagamento cancelado. Apenas o cancelamento do pedido est√°
                        dispon√≠vel.</small>
                </div>
                <button class="btn btn-danger" onclick="confirmCancel('{{ order.id }}')">
                    Cancelar Pedido
                </button>
                {% elif order.status == 'completed' and order.payment_status == 'cancelled' %}
                <!-- Entrega conclu√≠da com pagamento cancelado: pode cancelar a entrega -->
                <div class="status-box status-box-warning">
                    <strong>‚ö†Ô∏è Entrega Conclu√≠da - Pagamento Devolvido</strong>
                    <small>A entrega foi realizada, mas o pagamento foi cancelado/devolvido. Voc√™ pode cancelar a
                        entrega para refletir esta situa√ß√£o.</small>
                </div>
                <button class="btn btn-danger" onclick="confirmCancel('{{ order.id }}')">
                    Cancelar Entrega
                </button>
                {% elif order.status == 'cancelled' and order.payment_status == 'pending' %}
                <!-- Pedido cancelado com pagamento pendente: pode alterar pagamento -->
                <div class="status-box status-box-light">
                    <strong>‚ùå Pedido Cancelado - Pagamento Pendente</strong>
                    <small>O pedido foi cancelado, mas o pagamento ainda est√° pendente. Voc√™ pode alterar o status do
                        pagamento.</small>
                </div>
                <form method="post" action="{% url 'dashboard:order_toggle_payment_status' order.pk %}"
                    style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-payment" style="width: 100%;">
                        Marcar como Pago
                    </button>
                </form>
                {% elif order.status == 'cancelled' and order.payment_status == 'paid' %}
                <!-- Pedido cancelado mas j√° pago: deve devolver o dinheiro -->
                <div class="status-box status-box-danger">
                    <strong>‚ùå Pedido Cancelado - Precisa Devolver Pagamento</strong>
                    <small>O pedido foi cancelado, mas o pagamento foi recebido. √â necess√°rio cancelar o pagamento para
                        devolver o dinheiro ao cliente.</small>
                </div>
                <form method="post" action="{% url 'dashboard:order_cancel_payment' order.pk %}" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning" style="width: 100%;"
                        onclick="return confirm('Tem certeza que deseja cancelar este pagamento? Esta a√ß√£o indica que o dinheiro foi devolvido ao cliente.')">
                        Cancelar Pagamento (Devolver)
                    </button>
                </form>
                {% elif order.status == 'completed' and order.payment_status == 'pending' %}
                <!-- Entrega conclu√≠da mas pagamento pendente: pode marcar como pago -->
                <div class="status-box status-box-info">
                    <strong>‚úÖ Entrega Conclu√≠da - Aguardando Pagamento</strong>
                    <small>A entrega foi realizada com sucesso. Confirme o recebimento do pagamento.</small>
                </div>
                <form method="post" action="{% url 'dashboard:order_toggle_payment_status' order.pk %}"
                    style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        Confirmar Pagamento
                    </button>
                </form>
                {% else %}
                <!-- L√≥gica normal para outros casos -->
                {% if order.status == 'pending' and not order.is_finalized %}
                <a href="{% url 'dashboard:order_edit' order.pk %}" class="btn btn-primary">
                    Editar Pedido
                </a>
                <form method="post" action="{% url 'dashboard:order_toggle_status' order.pk %}" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        Concluir Pedido
                    </button>
                </form>
                {% endif %}
                {% if order.payment_status != 'cancelled' and not order.is_finalized and order.status == 'pending' %}
                <!-- Grupo para bot√µes de pagamento e cancelamento quando ambos devem aparecer -->
                <div class="payment-cancel-group">
                    <form method="post" action="{% url 'dashboard:order_toggle_payment_status' order.pk %}"
                        style="flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn {% if order.payment_status == 'pending' %}btn-payment{% else %}btn-warning{% endif %}" style="width: 100%;">
                            {% if order.payment_status == 'pending' %}
                            Marcar como Pago
                            {% else %}
                            Marcar como Pendente
                            {% endif %}
                        </button>
                    </form>
                    <button class="btn btn-danger" onclick="confirmCancel('{{ order.id }}')">
                        Cancelar Pedido
                    </button>
                </div>
                {% else %}
                <!-- Bot√µes individuais quando apenas um deve aparecer -->
                {% if order.payment_status != 'cancelled' and not order.is_finalized %}
                <form method="post" action="{% url 'dashboard:order_toggle_payment_status' order.pk %}"
                    style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn {% if order.payment_status == 'pending' %}btn-payment{% else %}btn-warning{% endif %}" style="width: 100%;">
                        {% if order.payment_status == 'pending' %}
                        Marcar como Pago
                        {% else %}
                        Marcar como Pendente
                        {% endif %}
                    </button>
                </form>
                {% endif %}
                {% if order.status == 'pending' and not order.is_finalized %}
                <button class="btn btn-danger" onclick="confirmCancel('{{ order.id }}')">
                    Cancelar Pedido
                </button>
                {% endif %}
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</main>

<script>
    function confirmCancel(orderId) {
        if (confirm('Tem certeza que deseja cancelar este pedido? Esta a√ß√£o n√£o pode ser desfeita.')) {
            const cancelBtn = event.target;
            cancelBtn.classList.add('loading');
            cancelBtn.textContent = 'Cancelando...';

            fetch(`/dashboard/orders/${orderId}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            }).then(response => {
                if (response.ok) {
                    window.location.href = '{% url "dashboard:order_list" %}';
                } else {
                    alert('Erro ao cancelar o pedido.');
                    cancelBtn.classList.remove('loading');
                    cancelBtn.textContent = 'Cancelar Pedido';
                }
            }).catch(() => {
                alert('Erro ao cancelar o pedido.');
                cancelBtn.classList.remove('loading');
                cancelBtn.textContent = 'Cancelar Pedido';
            });
        }
    }

    // Add loading state to form submission buttons
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function (e) {
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.classList.add('loading');
                    const originalText = submitBtn.textContent;

                    if (submitBtn.classList.contains('btn-success')) {
                        submitBtn.textContent = 'Processando...';
                    } else if (submitBtn.classList.contains('btn-payment')) {
                        submitBtn.textContent = 'Alterando...';
                    } else if (submitBtn.classList.contains('btn-warning')) {
                        submitBtn.textContent = 'Cancelando...';
                    }

                    // Reset if form validation fails
                    setTimeout(() => {
                        if (submitBtn.classList.contains('loading')) {
                            submitBtn.classList.remove('loading');
                            submitBtn.textContent = originalText;
                        }
                    }, 5000);
                }
            });
        });

        // Add touch feedback for mobile devices
        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(button => {
            button.addEventListener('touchstart', function () {
                this.style.transform = 'scale(0.98)';
            });

            button.addEventListener('touchend', function () {
                this.style.transform = '';
            });
        });
    });
</script>
{% endblock %}